<%@classes = Classe.find(:all, :conditions => ['unidade_id = ? and classe_ano_letivo = ? ', current_user.unidade_id, Time.now.year  ], :order => 'classe_classe ASC')%>
<%if current_user.has_role?('direcao_fundamental') or current_user.has_role?('professor_fundamental')%>
   <%@disciplinas = Disciplina.find(:all, :select => 'DISTINCT (disciplinas.disciplina), disciplinas.id', :joins => "INNER JOIN atribuicaos ON disciplinas.id = atribuicaos.disciplina_id INNER JOIN classes ON classes.id = atribuicaos.classe_id INNER JOIN unidades ON unidades.id = classes.unidade_id ", :conditions => ['classes.unidade_id =? and atribuicaos.ano_letivo=?', current_user.unidade_id, Time.now.year]) %>
<%end%>
<div id="interno6">
<% title "CONSULTA_CLASSE".singularize %>
<div class="tabs">
 <div id="caixa_titulo">
     <font size="3"><strong>LANÇAMENTOS DE FALTAS</strong></font><br/>

 </div>
    <div class="tabs">

      <fieldset>
        <table width="100%" align="center" bgcolor="#DCDCDC" >

          <tr>
              <td><b>Data:</b> </td>
              <td><%= @faltasaluno.data.strftime("%d/%m/%Y")   %> </td>
          </tr>
         <tr>
           <td> <b></b>Professor(a): </td>
           <td> <%=  @faltasaluno.professor.nome %>
             </td>
          </tr>
           <tr>
              <td width =" 5%" valign="top"><b><b>Quantidade:</b> </b></td>
               <td> <%=  @faltasaluno.faltas%> faltas</td>
            </tr>
             <tr>
                 <td align="left"><font size="2"> <b>Disciplina:</b></font></td>
                 <td><%=  @faltasaluno.disciplina.disciplina%> </td>
                </tr>

                <tr>
                    <td align="left"><font size="2"> <b>Classe:</b></font></td>
                    <td> <%=  @faltasaluno.classe.classe_classe %> - <%=  @faltasaluno.unidade.nome %></td>


                </tr>
                <tr>
                    <td align="left"><font size="2"> <b>Observações:</b></font></td>
                    <td> <%= session[:obser]%></td>

                </tr>

       </table>
       </fieldset>
      <fieldset>
        <table border="1" cellspacing="0" cellpadding="1" width="100%" bgcolor="#F5F5F5" >
          <tr>
            <td>
              <div id="alunos"><b><u> Alunos que faltaram:</u></b><br/><br/>
                 <% for aluno in @alunos_faltaram %>
                     &nbsp&nbsp&nbsp&nbsp - &nbsp<%= aluno.aluno_nome %> <br/>
                  <%end%>
                </div>
              <br/>
            </td>
          </tr>
       </table>


      </fieldset>

       <br/>
   <table>
    <tr>
     <td ><%= button_to 'Fechar', home_path, {:method => "get"}  %></td>


    </tr>
  </table>
 </div>



</div>

<br/>
</div>

<style type="text/css">
    .textovertical {
        -webkit-transform:rotate(270deg);
        -moz-transform:rotate(270deg);
        -o-transform: rotate(270deg);
    }
</style>


        <%t=0%>
        <%if   @faltasalunos.present?%>
            <fieldset>
                <table width="100%" style="font-size: small">
                         <tr bgcolor="#F5F5F5">
                            <td valign="top"> <b> Professor:</b> </td>
                            <%@professor=Professor.find(@faltasalunos[0].professor_id)%>
                            <%@disciplina=Disciplina.find(@faltasalunos[0].disciplina_id)%>
                            <%t0=0%>
                            <td align="left" width="45%"> <%=h @professor.nome%></td>
                             <td align="left" width="10%"><b> Ano Letivo:</b></td>
                            <td align="left"> <%=h@faltasalunos[0].ano_letivo %>     <%  session[:classe]= @faltasalunos[0].classe_id%></td>                            <% cont=1 %>
                            <% cont1=1 %>

                        </tr>

                        <tr bgcolor="#F5F5F5" >
                            <td align="left" width="10%"><b>Unidade:</b></td>
                            <td align="left">  <%=h@faltasalunos[0].unidade.nome%>    <%  session[:unidade]= @faltasalunos[0].unidade.nome %></td>
                            <td align="left"><b>Classe:</b></td>
                            <td align="left">  <%=h @faltasalunos[0].classe.classe_classe%>
                                                 &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp <b>Horário:</b> <%=h@faltasalunos[0].classe.horario %></td>
                        </tr>

                        <tr bgcolor="#F5F5F5">

                            <% if  session[:tela_faltas_aluno]==1%>
                               <td align="left"><b>Relatórios:</b></td>
                               <td align="left" colspan="3" > <b>de </b>&nbsp <%=h  session[:dataINI]%>   &nbsp&nbsp <b>à</b>  &nbsp<%=h  session[:dataFIM]%></td>

                            <%else%>
                               <td align="left"><b>Relatórios:</b></td>
                               <td align="left" > <b>de </b>&nbsp <%=h  session[:dataINI]%>   &nbsp&nbsp <b>à</b>  &nbsp<%=h  session[:dataFIM]%></td>
                               <td align="left"><b>Disciplina:</b></td>
                               <td align="left">  <%=h @faltasalunos[0].disciplina.disciplina%></td>
                            <%end%>
                        </tr

                        </tr>
                    </table>
                </fieldset>
                  <table  border="1" frame="box" rules="all" width="100%" style="font-size: small">
                    <tr bgcolor="#F5F5F5">
                       <% if  session[:tela_faltas_aluno]==1%>
                          <td width ="78%" colspan="2"><br/><br/><br/>&nbsp&nbsp<b> Alunos: </b> <br/><br/><br/></td>
                          <%@faltasalunosdiasAluno.each do |disciplina| %>
                                 <td align="center" ><div class="textovertical"><b><%=  truncate(disciplina.disciplina.disciplina,:length => 14,:omission => "...") %></b><br/>
                                                     (<%=  disciplina.data.strftime("%d/%m/%Y") %>


                                   </div></td>
                          <%end%>


                      <%else%>
                         <td width ="78%" colspan="2"><br/><br/><br/>&nbsp&nbsp<b> Alunos: </b> <br/><br/><br/></td>
                          <%@faltasalunosdias.each do |data| %>
                                 <td align="center" ><div class="textovertical"><b><%=  data.data.strftime("%d/%m/%Y") %></b></div></td>
                          <%end%>
                     <%end%>
                    </tr>
             <tr bgcolor="#F5F5F5">
                        <td colspan="13"> <div id="atividades_aluno">
                                    <% @alunos_matriculados.each do |alunos_mat|%>
                                            <tr bgcolor="#F5F5F5">
                                                <td width ="4%" align="center"><%= alunos_mat.classe_num %>  </td>
<!--                                                <%#*<td width ="10%" ><%= atividade.matricula.aluno.aluno_ra  %></td>%>-->
                                                <td width ="40%" align="left"><%= alunos_mat.aluno_nome %>
                                                </td>
                                                <%cont_ativ=0%>
                                                <%@faltasalunosdias.each do |faltasdias|%>
                                                <% if  session[:tela_faltas_aluno]==1%>
                                                    <%@faltasalunosdiasT = Faltasaluno.find(:all, :select=>  'data ,aluno_id, matricula_id, atribuicao_id, classe_id, professor_id, disciplina_id , ano_letivo,faltas  ', :joins =>:classe, :conditions =>  ["data >=? AND  data <=? AND classe_id = ? AND disciplina_id=? AND professor_id=? AND data=?", session[:dataI], session[:dataF],session[:cont_classe_id], faltasdias.disciplina_id,  current_user.professor_id, faltasdias.data] , :order => 'classe_id ASC')%>
                                                <%else%>
                                                    <%@faltasalunosdiasT = Faltasaluno.find(:all, :select=>  'distinct(data) ,aluno_id, matricula_id, 	atribuicao_id, 	classe_id, 	professor_id,  	disciplina_id , ano_letivo, faltas  ', :joins =>:classe, :conditions =>  ["data >=? AND  data <=? AND classe_id = ? AND disciplina_id=? AND professor_id=? AND data=?", session[:dataI], session[:dataF],session[:cont_classe_id], session[:disciplina_id],  current_user.professor_id, faltasdias.data] , :order => 'classe_id ASC')%>
                                                <%end%>
                                                <td align="center">
                                                    <table >
                                                        <tr>
                                                            <td align="center">
                                                             <%@faltasalunosdiasT.each do |falatasdiasT|%>
                                                                 <% if falatasdiasT.aluno_id == alunos_mat.id  %>
                                                              <font color="red"> <b>F </b>  (<%= falatasdiasT.faltas%>)
                                                                 <%else%>
                                                                    P
                                                                    <%break%>
                                                                 <%end%>
                                                             <%end%>
                                                            </td>
                                                        </tr>
                                                       </table>
                                                    </td>
                                                <%end%>

                                            </tr>
                                      <%end%>

                            </div></td>
                    </tr>

              </table>

     <%end%>
<br/>

  <%session[:tela_faltas_aluno]=0%>
    </table>
